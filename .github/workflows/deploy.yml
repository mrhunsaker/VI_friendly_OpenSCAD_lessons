name: Build and Deploy Book

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Pandoc 3.6.4
        run: |
          wget -q https://github.com/jgm/pandoc/releases/download/3.6.4/pandoc-3.6.4-1-amd64.deb
          sudo dpkg -i pandoc-3.6.4-1-amd64.deb
          pandoc --version

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Add cargo bin to PATH
        run: echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install mdBook and mdbook-pandoc
        run: |
          cargo install mdbook --locked
          cargo install mdbook-pandoc --locked

      - name: Install TeX Live
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            texlive-latex-base \
            texlive-latex-recommended \
            texlive-latex-extra \
            texlive-fonts-recommended \
            texlive-fonts-extra \
            texlive-luatex \
            texlive-xetex \
            lmodern \
            fonts-atkinson-hyperlegible

      # mdbook build triggers ALL backends defined in book.toml in one shot:
      #   output.html   → docs/html/
      #   output.pandoc → docs/pandoc/epub/  and  docs/pandoc/latex/
      # Never call mdbook-pandoc directly — it only works when piped from mdbook.
      - name: Build book (all backends)
        run: |
          cd my-book
          mdbook build

      # Pandoc writes the .tex file but does NOT copy images alongside it.
      # lualatex resolves \includegraphics relative to the .tex file's directory,
      # so we mirror the repo's src/ tree into the latex output dir first.
      - name: Copy source assets into latex output directory
        run: |
          cp -r my-book/src my-book/docs/pandoc/latex/src

      # lualatex MUST run from the directory containing the .tex file so that
      # relative \includegraphics paths (e.g. src/assets/images/bio-photo.jpg)
      # resolve correctly.
      - name: Compile LaTeX → PDF
        run: |
          OUT_DIR="my-book/docs/pandoc/latex"
          TEX="OpenSCAD_Curriculum.tex"

          cd "$OUT_DIR"

          # Pass 1 — generates .aux, .toc, .idx
          lualatex --interaction=nonstopmode "$TEX"

          # Build index from .idx produced in pass 1
          makeindex "OpenSCAD_Curriculum.idx" || true

          # Pass 2 — embeds TOC, cross-references, and index
          lualatex --interaction=nonstopmode "$TEX"

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: my-book/docs/html

      - name: Upload pandoc outputs
        uses: actions/upload-artifact@v4
        with:
          name: pandoc-outputs
          path: |
            my-book/docs/pandoc/epub/OpenSCAD_Curriculum.epub
            my-book/docs/pandoc/latex/OpenSCAD_Curriculum.tex
            my-book/docs/pandoc/latex/OpenSCAD_Curriculum.pdf
          if-no-files-found: warn

  deploy:
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
