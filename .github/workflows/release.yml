name: Build and Release mdBook with Pandoc and LaTeX

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Pandoc 3.6.4
        run: |
          wget -q https://github.com/jgm/pandoc/releases/download/3.6.4/pandoc-3.6.4-1-amd64.deb
          sudo dpkg -i pandoc-3.6.4-1-amd64.deb
          pandoc --version

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Add cargo bin to PATH
        run: echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install mdBook and mdbook-pandoc
        run: |
          cargo install mdbook --locked
          cargo install mdbook-pandoc --locked

      - name: Install TeX Live
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            texlive-latex-base \
            texlive-latex-recommended \
            texlive-latex-extra \
            texlive-fonts-recommended \
            texlive-fonts-extra \
            texlive-luatex \
            texlive-xetex \
            lmodern \
            fonts-atkinson-hyperlegible

      # IDENTICAL to deploy.yml
      - name: Build book (all backends)
        run: |
          cd my-book
          mdbook build

      - name: Copy source assets into latex output directory
        run: |
          cp -r my-book/src my-book/docs/pandoc/latex/src

      - name: Compile LaTeX â†’ PDF
        run: |
          OUT_DIR="my-book/docs/pandoc/latex"
          TEX="OpenSCAD_Curriculum.tex"

          cd "$OUT_DIR"

          # Pass 1
          lualatex --interaction=nonstopmode "$TEX"

          # Build index
          makeindex "OpenSCAD_Curriculum.idx" || true

          # Pass 2
          lualatex --interaction=nonstopmode "$TEX"

      - name: Verify release artifacts exist
        run: |
          test -f my-book/docs/pandoc/epub/OpenSCAD_Curriculum.epub
          test -f my-book/docs/pandoc/latex/OpenSCAD_Curriculum.tex
          test -f my-book/docs/pandoc/latex/OpenSCAD_Curriculum.pdf

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            my-book/docs/pandoc/epub/OpenSCAD_Curriculum.epub
            my-book/docs/pandoc/latex/OpenSCAD_Curriculum.tex
            my-book/docs/pandoc/latex/OpenSCAD_Curriculum.pdf
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
