name: Build and Release mdBook with Pandoc and LaTeX

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Pandoc 3.6.4
        run: |
          wget -q https://github.com/jgm/pandoc/releases/download/3.6.4/pandoc-3.6.4-1-amd64.deb
          sudo dpkg -i pandoc-3.6.4-1-amd64.deb
          pandoc --version

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Add cargo bin to PATH
        run: echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install mdBook and mdbook-pandoc
        run: |
          cargo install mdbook --locked
          cargo install mdbook-pandoc --locked

      - name: Install TeX Live
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            texlive-latex-base \
            texlive-latex-recommended \
            texlive-latex-extra \
            texlive-fonts-recommended \
            texlive-fonts-extra \
            texlive-luatex \
            texlive-xetex \
            lmodern \
            fonts-atkinson-hyperlegible

      - name: Print tool versions
        run: |
          mdbook --version
          mdbook-pandoc --version
          pandoc --version
          lualatex --version

      # mdbook build handles all backends from book.toml in one call.
      # Never invoke mdbook-pandoc directly — it reads JSON from mdbook's stdin.
      - name: Build book (HTML + EPUB + LaTeX source)
        run: |
          cd my-book
          mdbook build

      # Pandoc writes the .tex file but does NOT copy images alongside it.
      # lualatex resolves \includegraphics relative to the .tex file's directory,
      # so we mirror the repo's src/ tree into the latex output dir first.
      - name: Copy source assets into latex output directory
        run: |
          cp -r my-book/src my-book/docs/pandoc/latex/src

      # cd into the latex output dir so relative image paths resolve.
      - name: Compile LaTeX → PDF
        run: |
          OUT_DIR="my-book/docs/pandoc/latex"
          TEX="OpenSCAD_Curriculum.tex"

          cd "$OUT_DIR"

          lualatex --interaction=nonstopmode "$TEX"
          makeindex "OpenSCAD_Curriculum.idx" || true
          lualatex --interaction=nonstopmode "$TEX"

      - name: Collect release artefacts
        run: |
          mkdir -p release
          cp my-book/docs/pandoc/epub/OpenSCAD_Curriculum.epub  release/
          cp my-book/docs/pandoc/latex/OpenSCAD_Curriculum.tex  release/
          cp my-book/docs/pandoc/latex/OpenSCAD_Curriculum.pdf  release/

      - name: Create Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release/OpenSCAD_Curriculum.epub
            release/OpenSCAD_Curriculum.tex
            release/OpenSCAD_Curriculum.pdf
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
