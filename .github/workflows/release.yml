name: Build and Release mdBook with Pandoc and LaTeX

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install pandoc
        run: sudo apt-get update && sudo apt-get install -y pandoc

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Add cargo bin to PATH
        run: echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install mdBook and plugins via cargo
        run: |
          cargo install mdbook --locked || cargo install mdbook --force
          cargo install mdbook-pandoc --locked || cargo install mdbook-pandoc --force
          cargo install mdbook-bib --locked || cargo install mdbook-bib --force

      - name: "CI: debug versions"
        run: |
          mdbook --version || true
          mdbook-pandoc --version || true
          rustc --version || true
          cargo --version || true
          python3 --version || true

      - name: Install TeX Live (LaTeX)
        run: sudo apt-get install -y texlive-latex-base texlive-latex-recommended texlive-latex-extra texlive-fonts-recommended lualatex

      - name: Build book (HTML)
        run: |
          cd my-book
          mdbook build

      - name: Build EPUB and LaTeX via mdbook-pandoc
        run: |
          cd my-book
          mdbook-pandoc epub
          mdbook-pandoc latex

      - name: Build PDF via lualatex (run twice)
        run: |
          cd my-book
          lualatex book.tex
          lualatex book.tex

      - name: Move EPUB and PDF to release folder
        run: |
          mkdir -p release
          mv my-book/book.epub release/
          mv my-book/book.pdf release/

      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release/book.epub
            release/book.pdf
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
